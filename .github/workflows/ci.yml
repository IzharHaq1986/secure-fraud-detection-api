# .github/workflows/ci.yml
#
# CI Pipeline (DevSecOps)
# - Deterministic installs via requirements.lock.txt
# - Verifies the lock file matches what got installed (order-insensitive)
# - Lints with Ruff
# - Scans dependencies with pip-audit
# - Runs pytest explicitly against the tests/ folder (prevents "collected 0 items" surprises)
#
# Notes:
# - We upgrade ONLY pip to avoid modifying the locked environment unnecessarily.
# - We include lightweight debug steps to make CI failures self-explanatory.

name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  ci:
    runs-on: ubuntu-latest
    env:
    # Provide API keys to tests in CI (no .env file exists in the runner).
    API_KEY_ADMIN: ${{ secrets.API_KEY_ADMIN }}
    API_KEY_SERVICE: ${{ secrets.API_KEY_SERVICE }}

    steps:
      # Checkout repository code.
      - name: Checkout
        uses: actions/checkout@v4

      # Use a consistent Python version in CI.
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # Upgrade pip only (avoid changing setuptools/wheel unexpectedly).
      - name: Upgrade pip
        run: |
          python -m pip install --upgrade pip

      # Install dependencies from the fully pinned lock file.
      - name: Install dependencies (locked)
        run: |
          python -m pip install -r requirements.lock.txt

      # Debug: confirm repository layout and test files exist in the runner checkout.
      - name: Debug workspace (repo + tests)
        run: |
          echo "=== Repo root ==="
          pwd
          ls -la

          echo ""
          echo "=== tests/ folder ==="
          ls -la tests || true

          echo ""
          echo "=== Test files ==="
          find tests -maxdepth 2 -type f -print || true

      # Verify the lock file matches what is installed.
      # This script should sort before diffing to avoid order-only mismatches.
      - name: Verify requirements lock
        run: |
          bash scripts/check_requirements_lock.sh

      # Lint the codebase.
      - name: Ruff lint
        run: |
          ruff check .

      # Scan dependencies for known vulnerabilities.
      - name: Dependency audit (pip-audit)
        run: |
          pip-audit

      # Run unit tests explicitly from the tests/ folder.
      # This prevents pytest discovery/config edge cases from reporting "collected 0 items".
      - name: Run test suite
        run: |
          pytest -v tests
