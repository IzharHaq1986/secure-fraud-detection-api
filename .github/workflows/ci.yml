# .github/workflows/ci.yml
#
# CI Pipeline (DevSecOps)
# - Reproducible installs using requirements.lock.txt
# - Lock verification (with debug print so we know exactly what CI runs)
# - Lint (Ruff), vulnerability scan (pip-audit), and tests (pytest)
#
# Notes:
# - We upgrade ONLY pip to avoid changing the locked environment.
# - We run the lock script via bash for portability.
# - The "Show lock-check script" step is temporary but extremely useful for diagnosing CI drift.

name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository code.
      - name: Checkout
        uses: actions/checkout@v4

      # Use a consistent Python version in CI.
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # Upgrade pip only (avoid modifying the environment with setuptools/wheel).
      - name: Upgrade pip
        run: |
          python -m pip install --upgrade pip

      # Install dependencies from the fully pinned lock file.
      - name: Install dependencies (locked)
        run: |
          python -m pip install -r requirements.lock.txt

      # Debug: confirm repository layout exists as expected in CI.
      - name: Debug workspace (confirm scripts path)
        run: |
          pwd
          ls -la
          ls -la scripts || true

      # Debug: print the exact script CI will run (prevents "wrong script" confusion).
      - name: Show lock-check script (CI debug)
        run: |
          echo "----- scripts/check_requirements_lock.sh (start) -----"
          sed -n '1,200p' scripts/check_requirements_lock.sh
          echo "----- scripts/check_requirements_lock.sh (end) -----"

      # Verify the lock file matches what is installed.
      - name: Verify requirements lock
        run: |
          bash scripts/check_requirements_lock.sh

      # Lint the codebase.
      - name: Ruff lint
        run: |
          ruff check .

      # Scan dependencies for known vulnerabilities.
      - name: Dependency audit (pip-audit)
        run: |
          pip-audit

      # Run unit tests to prevent regressions.
      - name: Run test suite
        run: |
          pytest -v
