# .github/workflows/ci.yml
#
# CI Pipeline (DevSecOps)
# - Deterministic installs via requirements.lock.txt
# - Lock verification via scripts/check_requirements_lock.sh
# - Linting (Ruff)
# - Vulnerability scanning (pip-audit)
# - SBOM generation (CycloneDX) with version-tolerant flags + upload as artifact
# - Tests with scoped coverage enforcement (pytest-cov)
#
# Notes:
# - CI runners do NOT load your local .env
# - Provide API keys via GitHub Actions Secrets:
#     API_KEY_ADMIN
#     API_KEY_SERVICE

name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  ci:
    runs-on: ubuntu-latest

    # CI environment variables (no .env file in the runner).
    env:
      API_KEY_ADMIN: ${{ secrets.API_KEY_ADMIN }}
      API_KEY_SERVICE: ${{ secrets.API_KEY_SERVICE }}

    steps:
      # Checkout repository code.
      - name: Checkout
        uses: actions/checkout@v4

      # Use a consistent Python version in CI.
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # Upgrade pip only (avoid modifying setuptools/wheel unexpectedly).
      - name: Upgrade pip
        run: |
          python -m pip install --upgrade pip

      # Install dependencies from the fully pinned lock file.
      - name: Install dependencies (locked)
        run: |
          python -m pip install -r requirements.lock.txt

      # Debug: confirm scripts/ and tests/ exist in the runner checkout.
      - name: Debug workspace (repo + scripts + tests)
        run: |
          echo "=== Repo root ==="
          pwd
          ls -la

          echo ""
          echo "=== scripts/ ==="
          ls -la scripts || true

          echo ""
          echo "=== tests/ ==="
          ls -la tests || true
          find tests -maxdepth 2 -type f -print || true

      # Verify the lock file matches what is installed.
      - name: Verify requirements lock
        run: |
          bash scripts/check_requirements_lock.sh

      # Lint the codebase.
      - name: Ruff lint
        run: |
          ruff check .

      # Scan dependencies for known vulnerabilities.
      - name: Dependency audit (pip-audit)
        run: |
          pip-audit

      # Generate an SBOM (Software Bill of Materials) for supply-chain visibility.
      # CycloneDX Python CLI flags differ across versions, so we try common variants.
      - name: Generate SBOM (CycloneDX)
        run: |
          set -euo pipefail

          # Variant A (newer CLI): --spec-version and --output-file
          if cyclonedx-py environment --spec-version 1.6 --output-format JSON --output-file sbom.cdx.json; then
            echo "SBOM generated using --output-file/--spec-version"
          # Variant B (older CLI): --schema-version and --outfile
          elif cyclonedx-py environment --schema-version 1.6 --output-format JSON --outfile sbom.cdx.json; then
            echo "SBOM generated using --outfile/--schema-version"
          else
            echo "ERROR: cyclonedx-py CLI flags did not match installed version."
            echo "Hint: inspect help output with: cyclonedx-py environment --help"
            exit 1
          fi

      # Upload SBOM as an artifact for audits and incident response.
      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: sbom.cdx.json

      # Run unit tests with coverage (scoped to exercised modules).
      # Fail CI if coverage drops below 85% for these modules.
      - name: Run test suite with coverage
        run: |
          pytest \
            -v tests \
            --cov=app.main \
            --cov=app.routes \
            --cov=app.schemas \
            --cov-report=term-missing \
            --cov-fail-under=85
